version: '3.8'

services:
  step-daddy-live-hd:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${PORT:-3232}:${PORT:-3232}"
      - "${BACKEND_PORT:-8005}:${BACKEND_PORT:-8005}"
      - "2019:2019"  # Expose Caddy admin port for debugging
    environment:
      - PORT=${PORT:-3232}
      - BACKEND_PORT=${BACKEND_PORT:-8005}
      - BACKEND_URI=http://localhost:${BACKEND_PORT:-8005}
      - API_URL=http://localhost:${PORT:-3232}
      - DADDYLIVE_URI=${DADDYLIVE_URI:-https://thedaddy.click}
      - PROXY_CONTENT=${PROXY_CONTENT:-TRUE}
      - SOCKS5=${SOCKS5:-}
      - WORKERS=${WORKERS:-6}
      - REFLEX_ENV=prod
      - REFLEX_FRONTEND_ONLY=true
      - REFLEX_SKIP_COMPILE=1
      # Add proxy environment variables
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - NO_PROXY=localhost,127.0.0.1
    networks:
      step-daddy-network:
        aliases:
          - step-daddy-live-hd
    dns:
      - 8.8.8.8  # Use Google DNS as primary
      - 1.1.1.1  # Use Cloudflare DNS as backup
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Allow container to access host network
    restart: unless-stopped

networks:
  step-daddy-network:
    driver: bridge
    # Enable internet access
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.bridge.enable_icc: "true"